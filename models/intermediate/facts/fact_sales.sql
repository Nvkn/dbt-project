-- models/fact_sales.sql

{{ config(
    materialized='incremental',
    unique_key= ['S_ORDERKEY', 'S_LINENUMBER']
) }}

WITH source_data AS (
    SELECT
        O_ORDERKEY AS S_ORDERKEY,
        L_LINENUMBER AS S_LINENUMBER,
        O_CUSTKEY AS S_CUSTKEY,
        O_ORDERSTATUS AS S_ORDERSTATUS,
        O_TOTALPRICE AS S_TOTALPRICE_USD,
        O_TOTALPRICE*N_C.N_USD_TO_LOCAL AS S_TOTALPRICE_CUSTOMER,
        O_TOTALPRICE*N_ST.N_USD_TO_LOCAL AS S_TOTALPRICE_STORE,

        TO_CHAR(O_ORDERDATE, 'YYYYMMDDHH24MISS')::INT AS S_Orderdatekey,
        TO_CHAR(CONVERT_TIMEZONE('UTC', N_C.N_TIMEZONE, O_ORDERDATE), 'YYYYMMDDHH24MISS')::INT AS S_Orderdatekey_Customer,
        TO_CHAR(CONVERT_TIMEZONE('UTC', N_ST.N_TIMEZONE, O_ORDERDATE), 'YYYYMMDDHH24MISS')::INT AS S_Orderdatekey_Store,
        O_ORDERPRIORITY AS S_ORDERPRIORITY,
        TO_NUMBER(REGEXP_SUBSTR(O_CLERK, '\\d+')) AS S_CLERK,
        L_PARTKEY AS S_ITEMKEY,
        L_SUPPKEY AS S_SUPPKEY,
        L_QUANTITY AS S_QUANTITY,
        L_EXTENDEDPRICE AS S_EXTENDEDPRICE,
        L_DISCOUNT AS S_DISCOUNT,
        L_TAX AS S_TAX,
        L_LINESTATUS AS S_LINESTATUS,
        CASE L_RETURNFLAG
            WHEN 'N' THEN 'SALE'
            WHEN 'R' THEN 'RETURN'
        END AS S_OPERATIONTYPE,
        CASE
            WHEN DATEDIFF(DAY, L_COMMITDATE, L_RECEIPTDATE) > 10 THEN 0
            WHEN DATEDIFF(DAY, L_COMMITDATE, L_RECEIPTDATE) <= 0 THEN 1
            WHEN DATEDIFF(DAY, L_COMMITDATE, L_RECEIPTDATE) BETWEEN 1 AND 10 THEN 2
        END AS S_DELIVERYCOMPLIANCE,
        E_EVENTKEY AS S_EVENTKEY,
        O_STOREKEY AS S_STOREKEY,
        L_SHIPMODE AS S_SHIPMODE
    FROM {{ ref('stg_orders') }}
    JOIN {{ ref('stg_lineitem') }} ON O_ORDERKEY = L_ORDERKEY
    JOIN {{ ref('stg_customer') }} ON O_CUSTKEY = C_CUSTKEY
    JOIN {{ ref('stg_nation') }} N_C ON C_NATIONKEY = N_C.N_NATIONKEY
    JOIN {{ ref('stg_store') }} ON O_STOREKEY = ST_STOREKEY
    JOIN {{ ref('stg_nation') }} N_ST ON ST_NATIONKEY = N_ST.N_NATIONKEY
    LEFT JOIN {{ ref('stg_event') }} ON ST_NATIONKEY = E_NATIONKEY AND O_ORDERDATE BETWEEN E_START_DATE AND E_END_DATE
    WHERE L_RETURNFLAG IN ('N', 'R')
)

SELECT *
FROM source_data